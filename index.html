<!DOCTYPE html>
<html>
<head>
<title>canvas tests</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="jquery.min.js"></script> 
<script src="bootstrap.min.js"></script>

<script src="jquery.color-2.1.0.min.js"></script>
<script src="js.cookie-2.1.0.min.js"></script>

<script src="lib/codemirror.js"></script>
<script src="mode/scheme/scheme.js"></script>
<script src="addon/edit/matchbrackets.js"></script>
<script src="addon/edit/closebrackets.js"></script>
<script src="addon/selection/mark-selection.js"></script>

<script src="imgur_canvas.js"></script>

<script src="peer.js"></script>
<script src="compile.js"></script>
<script src="files.js"></script>
<script src="time.js"></script>
<script src="log.js"></script>
<script src="networking.js"></script>
<script src="progress.js"></script>
<script src="edit.js"></script>
<script src="main.js"></script>

<link rel='icon' href='data:;base64,iVBORw0KGgo='>

</head>
<body>

<div class="container">

<div class="panel panel-primary">
  <div class="panel-body small-panel">
    <a class="ajaxLink" title="Settings" onclick="$('#settings').toggle()"><span class="glyphicon glyphicon-cog" aria-hidden="true"></span></a>
    <span class="heading">Background Processing &bull;</span>
    <div class="panel panel-primary status-panel no-margin"><div class="panel-body smaller-panel" id="StatusPanel">Status: not running</div></div>
    <div id="WorkerInfo" class="starts-hidden">
    <span class="heading">&bull;</span>
    <div class="workerlist">
    </div>
    </div>
    <span class="heading">&bull;</span>
    <button type="button" id="ConnectButton" onclick="Connect();">Connect</button>
    <button type="button" id="DisconnectButton" onclick="Disconnect();" class="starts-hidden">Disconnect</button>
    <span class="heading">&bull;
    <span id="HelpedInfo"></span>
    </span>
    <div id="settings" class="starts-hidden">
      <hr class="sane">
      <div class="panel panel-primary no-margin">
        <div class="panel-body small-panel">
          <label for="target" title="Address of the discovery server (PeerServer)">Server</label>
          <input type="text" id="target" name="target" size="25" value="" oninput="CheckTarget();">
          <label for="threads" title="Number of background threads you contribute to the network. Default: 2">Threads</label>
          <input type="text" size="1" id="threads" name="threads" value="2" oninput="SaveSettings()">
          <label for="ident" title="Label used for this computer. Defaults to connection id.">Label</label>
          <input type="text" size="10" id="ident" name="ident" value="" oninput="SaveSettings()">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- :sigh: -->
<table><tr><td style="vertical-align:top;width:100%;height:100%;">

<div id="editors">
<ul id="riders" class="nav nav-tabs">
</ul>
<span id="editors_content" class="tab-content">
<textarea id="editor">(lambda (x y i) (vec3f 0.4 0.5 0.6))
; @file prelude

(def qmap (lambda (list)
  (if (= (size list) 0)
    list
    (cons (quasicode (first list)) (qmap (rest list))))))

(def quasicode (lambda (arg)
  (if (not (list? arg)) (quote arg)
    (if (same (first arg) 'unquote)
      (first1 (rest arg))
      (cons 'list (qmap arg))))))

(def quasiquote (macro (arg)
  (quasicode arg)))

(def and (macro (a b) `(if ,a (if ,b true false) false)))

(def or (macro (a b) `(if ,a true (if ,b true false))))

(def quotelist (lambda (list)
  (if (= (size list) 0)
    list
    (cons (quote (first list)) (quotelist (rest list))))))

(def let_fun (lambda (args)
  ; TODO error cases for (= size 0)
  (if (= (size args) 1)
    (first1 args) ; plain body
    (list
      'let1
      (first args)
      (let_fun (rest args))))))


(def let (macro (...)
  (let_fun ...)))

(def require (macro (...) (cons '_require (quotelist ...))))
(def : (macro (base ...) (cons '_element (cons base (quotelist ...)))))

; non-recursive to avoid browser erroring out due to stack overflow
(def slice (lambda (from to args) (let
  (from' from) (to' to) (args' args)
  (res '())
  (seq
    (while (or (> from 0) (> to 0))
      (if (> from 0)
        (seq
          (set from (- from 1))
          (set to (- to 1))
          (set args (rest args)))
        (seq
          (set res (cons (first args) res))
          (set to (- to 1))
          (set args (rest args)))))
    res))))

(def for (macro (var from to body)
  `(seq
    (let (,var ,from)
      (while (< ,var ,to) (let
        (_for_res ,body)
        (seq
          (set ,var (+ ,var 1))
          _for_res)))))))

; TODO vectors?
(def min (lambda (a b)
  (if (< a b) a b)))

(def max (lambda (a b)
  (if (> a b) a b)))

(def sum (lambda (vec) (+ (: vec x) (: vec y) (: vec z))))
(def length (lambda (vec) (sqrt (sum (* vec vec)))))
</textarea>
</span>
</div>

</td>
<td>

<div id="result_area">
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#image-pane" aria-controls="image-pane" role="tab" data-toggle="tab" id="image-tab">Render</a></li>
    <li role="presentation"><a href="#progress-pane" aria-controls="progress-pane" role="tab" data-toggle="tab" id="progress-tab">Progress</a></li>
    <li role="presentation" class="label label-outside" id="QuickProgInfo"></li>
  </ul>

  <div class="tab-content" style="position:relative;">
    <div role="tabpanel" class="tab-pane active" aria-labelledby="image-tab" id="image-pane" style="display: inherit;">
      <div id="canvas-wrapper">
        <canvas id="canvas" width="512" height="512"></canvas>
      </div>
    </div>
    <div role="tabpanel" class="tab-pane panel panel-default" aria-labelledby="progress-tab" id="progress-pane">
      <div class="panel-body" style="padding: 0px;">
        <div id="progress">
        </div>
      </div>
    </div>
  </div>
</div>

</td></tr></table>

<button type="button" id="RenderButton" onclick="RenderScene()">Render</button>
<button type="button" id="CancelButton" onclick="CancelRender()" class="starts-hidden">Cancel</button>
<script>
  $('#target')[0].defaultValue = location.host+"/jsfarm";
  LoadSettings();
  LoadStateFromAnchor(function() {
    if (!editor.files.length) {
      // build default
      editor.files = splitSrc($('#editor')[0].value);
      editor.rebuildFileUi(editor.files);
    }
    // $("#RenderButton").click();
  });
  setupCanvasUpload($('#canvas'));
</script>
<button type="button" id="SaveButton" onclick="Save()">Save</button>
&nbsp;|&nbsp;
<label for="width" title="Width of the rendered image. Please be considerate.">Width</label>
<input type="text" size="3" id="width" name="width" value="512">
<label for="height" title="Height of the rendered image. Please be considerate.">Height</label>
<input type="text" size="3" id="height" name="height" value="512">
<label for="quality" title="Passed to the script as param-quality.">Quality</label>
<input type="text" size="4" id="quality" name="quality" value="32">

<hr class="semisane">
<p>Console</p>
<div style="clear:both;"></div>
<div id="console">
</div>

<div style="text-align: center;"><span class="ajaxLink" onclick="setTheme('light');">[light]</span>&nbsp;<span class="ajaxLink" onclick="setTheme('dark');">[dark]</span></div>

</div>

<div class="modal" id="SiteLoadingModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document" style="padding-top: 5%;">
    <div class="modal-content">
      <div style="text-align: center;" class="modal-body">
        <h2>Page is loading.</h2>
        <h3>Please wait...</h3>
      </div>
    </div>
  </div>
</div>
</body>
</html>
