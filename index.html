<!DOCTYPE html>
<html>
<head>
<title>canvas tests</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="jquery.min.js"></script> 
<script src="bootstrap.min.js"></script>

<script src="jquery.color-2.1.0.min.js"></script>
<script src="js.cookie-2.1.0.min.js"></script>
<script src="dom-q.min.js"></script>
<script src="hashwords.min.js"></script>

<script src="lib/codemirror.js"></script>
<script src="renderlisp.js"></script>
<script src="addon/edit/matchbrackets.js"></script>
<script src="addon/edit/closebrackets.js"></script>
<script src="addon/selection/mark-selection.js"></script>

<script src="imgur_canvas.js"></script>

<script src="peer.js"></script>
<script src="compile.js"></script>
<script src="files.js"></script>
<script src="time.js"></script>
<script src="log.js"></script>
<script src="rgbe.js"></script>
<script src="networking.js"></script>
<script src="progress.js"></script>
<script src="edit.js"></script>
<script src="main.js"></script>

<link rel='icon' href='data:;base64,iVBORw0KGgo='>

</head>
<body>

<div class="container">

<div class="panel panel-primary">
  <div class="panel-body small-panel">
    <a class="ajaxLink" title="Settings" onclick="$('#settings').toggle()"><span class="glyphicon glyphicon-cog" aria-hidden="true"></span></a>
    <span class="heading">Background Processing &bull;</span>
    <div class="panel panel-primary status-panel no-margin"><div class="panel-body smaller-panel" id="StatusPanel">Status: not running</div></div>
    <div id="WorkerInfo" class="starts-hidden">
    <span class="heading">&bull;</span>
    <div class="workerlist">
    </div>
    </div>
    <span class="heading">&bull;</span>
    <button type="button" id="ConnectButton" onclick="Connect();">Connect</button>
    <button type="button" id="DisconnectButton" onclick="Disconnect();" class="starts-hidden">Disconnect</button>
    <span class="heading">&bull;
    <span id="HelpedInfo"></span>
    </span>
    <div id="settings" class="starts-hidden">
      <hr class="sane">
      <div class="panel panel-primary no-margin">
        <div class="panel-body small-panel">
          <label for="target" title="Address of the discovery server (PeerServer)">Server</label>
          <input type="text" id="target" name="target" size="25" value="" oninput="CheckTarget();">
          <label for="threads" title="Number of background threads you contribute to the network. Default: 2">Threads</label>
          <input type="text" size="1" id="threads" name="threads" value="2" oninput="SaveSettings()">
          <label for="ident" title="Label used for this computer. Defaults to connection id.">Label</label>
          <input type="text" size="10" id="ident" name="ident" value="" oninput="SaveSettings()">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- :sigh: -->
<table><tr><td style="vertical-align:top;width:100%;height:100%;">

<div id="editors">
<ul id="riders" class="nav nav-tabs">
</ul>
<span id="editors_content" class="tab-content">
<textarea id="editor">(lambda (x y i) (vec3f 0.4 0.5 0.6))
; @file prelude
(def fov 0.75)
; (def fov 0.2)

(def qmap
  (lambda (list)
    (if (= (size list) 0)
      list
      (cons (quasicode (first list)) (qmap (rest list))))))

(def quasicode
  (lambda (arg)
    (if (not (list? arg)) (quote arg)
      (if (same (first arg) 'unquote)
        (first1 (rest arg))
        (cons 'list (qmap arg))))))

(def quasiquote
  (macro (arg)
    (quasicode arg)))

(def andfn
  (lambda (arg)
    (if (= (size arg) 0)
      true
      (if (= (size arg) 1)
        (first arg)
        (list 'if (first arg) (andfn (rest arg)) false)))))

(def and (macro (...) (andfn ...)))

(def orfn
  (lambda (arg)
    (if (= (size arg) 0)
      false
      (if (= (size arg) 1)
        (first arg)
        (list 'if (first arg) true (orfn (rest arg)))))))

(def or (macro (...) (orfn ...)))

(def quotelist
  (lambda (list)
    (if (= (size list) 0)
      list
      (cons (quote (first list)) (quotelist (rest list))))))

(def let_fun
  (lambda (args)
    ; TODO error cases for (= size 0)
    (if (= (size args) 1)
      (first1 args) ; plain body
      (list
       'let1
       (first args)
       (let_fun (rest args))))))

(def let
  (macro (...)
    (let_fun ...)))

(def alias_fun
  (lambda (args)
    ; TODO error cases for (= size 0)
    (if (= (size args) 1)
      (first1 args) ; plain body
      (list
       'alias1
       (first args)
       (alias_fun (rest args))))))

(def alias
  (macro (...)
    (alias_fun ...)))

(def require (macro (...) (cons '_require (quotelist ...))))
(def : (macro (base ...) (cons '_element (cons base (quotelist ...)))))

; non-recursive to avoid browser erroring out due to stack overflow
(def slice
  (lambda (from to args)
    (let
      (from' from) (to' to) (args' args)
      (res '())
      (seq
       (while (or (> from 0) (> to 0))
         (if (> from 0)
           (seq
            (set from (- from 1))
            (set to (- to 1))
            (set args (rest args)))
           (seq
            (set res (cons (first args) res))
            (set to (- to 1))
            (set args (rest args)))))
       res))))

(def for
  (macro (var from to body)
    `(seq
      (let (,var ,from)
        (while (< ,var ,to)
          (let
            (_for_res ,body)
            (seq
             (set ,var (+ ,var 1))
             _for_res)))))))

(def splitfun
  (lambda (base args)
    (if (= (size args) 1)
      (first args)
      (let
        (pivot (/ (size args) 2))
        (left (splitfun base (slice 0 pivot args)))
        (right (splitfun base (slice pivot (size args) args)))
        (list base left right)))))

; TODO vectors?
(def min2
  (macro (a b)
    `(let
      (%a ,a)
      (%b ,b)
      (if (< %a %b) %a %b))))

(def min
  (macro (...)
    (splitfun 'min2 ...)))

(def max2
  (macro (a b)
    `(let
      (%a ,a)
      (%b ,b)
      (if (> %a %b) %a %b))))

(def max
  (macro (...)
    (splitfun 'max2 ...)))

(def Vec3f (vector-type 'float 3))
(def Vec4f (vector-type 'float 4))

(def SumType (function-type (list Vec3f) 'float))
(def sum (type SumType (lambda (vec) (+ (: vec x) (: vec y) (: vec z)))))

(def DotType (function-type (list Vec3f Vec3f) 'float))
(def dot (type DotType (lambda (v1 v2) (sum (* v1 v2)))))

(def length (lambda (vec) (sqrt (dot vec vec))))
(def length-squared (lambda (vec) (sum (* vec vec))))

(def NormType (function-type (list Vec3f) Vec3f))
(def normalized (type NormType (lambda (vec) (* vec (/ 1 (length vec))))))

(def angle
  (lambda (a b)
    (acos (dot (normalized a) (normalized b)))))

(def cross
  (lambda (a b)
    (vec3f
     (- (* a:y b:z) (* a:z b:y))
     (- (* a:z b:x) (* a:x b:z))
     (- (* a:x b:y) (* a:y b:x)))))
</textarea>
</span>
</div>

</td>
<td>

<div id="result_area">
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#image-pane" aria-controls="image-pane" role="tab" data-toggle="tab" id="image-tab">Render</a></li>
    <li role="presentation"><a href="#progress-pane" aria-controls="progress-pane" role="tab" data-toggle="tab" id="progress-tab">Progress</a></li>
    <li role="presentation" class="label label-outside" id="QuickProgInfo"></li>
  </ul>

  <div class="tab-content" style="position:relative;">
    <div role="tabpanel" class="tab-pane active" aria-labelledby="image-tab" id="image-pane" style="display: inherit;">
      <div id="canvas-wrapper">
        <canvas id="canvas" width="512" height="512"></canvas>
      </div>
    </div>
    <div role="tabpanel" class="tab-pane panel panel-default" aria-labelledby="progress-tab" id="progress-pane">
      <div class="panel-body" style="padding: 0px;">
        <div id="progress">
        </div>
      </div>
    </div>
  </div>
</div>

</td></tr></table>

<button type="button" id="RenderButton" onclick="RenderScene()">Render</button>
<button type="button" id="CancelButton" onclick="CancelRender()" class="starts-hidden">Cancel</button>
<script>
  $('#target')[0].defaultValue = location.host+"/jsfarm";
  LoadSettings();
  LoadStateFromAnchor(function() {
    if (!editor.files.length) {
      // build default
      editor.files = splitSrc($('#editor')[0].value);
      editor.rebuildFileUi(editor.files);
    }
    // $("#RenderButton").click();
  });
  setupCanvasUpload($('#canvas'));
</script>
<button type="button" id="SaveButton" onclick="Save()">Save</button>
&nbsp;|&nbsp;
<label for="width" title="Width of the rendered image. Please be considerate.">Width</label>
<input type="text" size="3" id="width" name="width" value="512">
<label for="height" title="Height of the rendered image. Please be considerate.">Height</label>
<input type="text" size="3" id="height" name="height" value="512">
<label for="quality" title="Passed to the script as param-quality.">Quality</label>
<input type="text" size="4" id="quality" name="quality" value="32">

<hr class="semisane">
<p>Console</p>
<div style="clear:both;"></div>
<div id="console">
</div>

<div style="text-align: center;"><span class="ajaxLink" onclick="setTheme('light');">[light]</span>&nbsp;<span class="ajaxLink" onclick="setTheme('dark');">[dark]</span></div>

</div>

<div class="modal" id="SiteLoadingModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document" style="padding-top: 5%;">
    <div class="modal-content">
      <div style="text-align: center;" class="modal-body">
        <h2>Page is loading.</h2>
        <h3>Please wait...</h3>
      </div>
    </div>
  </div>
</div>
</body>
</html>
